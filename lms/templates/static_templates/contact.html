<%namespace name='static' file='../static_content.html'/>
<%page expression_filter="h"/>
<%! from django.utils.translation import gettext as _ %>
<%inherit file="../main.html" />

<%block name="pagetitle">${_("Liên hệ")}</%block>

<main id="main" aria-label="Content" tabindex="-1">
  <section class="container about contact-page">
    <h1 class="contact-title">
      <%block name="pageheader">${page_header or _("Liên hệ")}</%block>
    </h1>

    <p class="contact-intro">
      <%block name="pagecontent">
        ${page_content or _("Bạn cần hỗ trợ hoặc có thắc mắc? Gửi tin nhắn bằng biểu mẫu bên dưới hoặc liên hệ trực tiếp bằng thông tin bên phải.")}
      </%block>
    </p>

    <div class="contact-grid">
      <!-- LEFT: Contact form -->
      <div class="contact-form-card" role="region" aria-labelledby="contact-form-title">
        <div class="card-head">
          <h2 id="contact-form-title" class="section-title">${_("Gửi tin nhắn cho chúng tôi")}</h2>
          <span class="badge">CUSC</span>
        </div>

        <!-- Form -->
        <form class="contact-form" id="contactForm" novalidate>
          <div class="grid-2">
            <div class="field">
              <label class="required" for="cf-name">${_("Họ và tên")}</label>
              <input id="cf-name" name="name" type="text" placeholder="${_('Tên của bạn')}" required />
              <small class="hint"></small>
            </div>

            <div class="field">
              <label class="required" for="cf-email">${_("Email")}</label>
              <input id="cf-email" name="email" type="email" placeholder="you@example.com" required />
              <small class="hint"></small>
            </div>
          </div>

          <div class="field">
            <label for="cf-subject">${_("Tiêu đề")}</label>
            <input id="cf-subject" name="subject" type="text" placeholder="${_('Nội dung liên hệ về vấn đề gì?')}" />
            <small class="hint"></small>
          </div>

          <div class="field">
            <label class="required" for="cf-message">${_("Nội dung tin nhắn")}</label>
            <textarea id="cf-message" name="message" rows="6" maxlength="1500" placeholder="${_('Nhập nội dung bạn muốn trao đổi...')}" required></textarea>
            <div class="meta-row">
              <small class="hint"></small>
              <small id="msgCount" class="count">0/1500</small>
            </div>
          </div>

          <button type="submit" class="btn primary" id="sendBtn">
            <span> ${_("Gửi tin nhắn")}</span>
          </button>

          <p class="form-hint">
            ${_("Bằng cách gửi tin nhắn, bạn đồng ý cho phép chúng tôi liên hệ lại qua email bạn đã cung cấp.")}
          </p>

          <!-- trạng thái gửi -->
          <div id="contactStatus" class="alert" aria-live="polite"></div>
        </form>
      </div>

      <!-- RIGHT: Contact info -->
      <aside class="contact-info-card" role="complementary" aria-labelledby="contact-info-title">
        <h2 id="contact-info-title" class="section-title">${_("Thông tin liên hệ")}</h2>

        <ul class="contact-list" aria-label="${_('Chi tiết liên hệ')}">
          <li><span class="ci-label">${_("Email")}:</span> <a href="mailto:info@cusc.vn">info@cusc.vn</a></li>
          <li><span class="ci-label">${_("Điện thoại")}:</span> <a href="tel:+842922835579">+84 292 2835 579</a></li>
          <li><span class="ci-label">${_("Địa chỉ")}:</span> ${_("01 Lý Tự Trọng, Quận Ninh Kiều, TP. Cần Thơ, Việt Nam")}</li>
          <li><span class="ci-label">${_("Giờ làm việc")}:</span> ${_("Thứ 2 – Thứ 6, 08:00–17:00 (GMT+7)")}</li>
        </ul>

        <div class="contact-social">
          <a href="#" aria-label="${_('Facebook')}" class="chip">Facebook</a>
          <a href="#" aria-label="${_('YouTube')}" class="chip">YouTube</a>
          <a href="#" aria-label="${_('Zalo')}" class="chip">Zalo</a>
        </div>
      </aside>
    </div>

    <!-- Map -->
    <div class="contact-map" role="region" aria-label="${_('Bản đồ vị trí')}">
      <iframe
        title="${_('Bản đồ vị trí CUSC')}"
        loading="lazy"
        allowfullscreen
        referrerpolicy="no-referrer-when-downgrade"
        src="https://www.google.com/maps?q=Can+Tho+University+Software+Center&output=embed">
      </iframe>
    </div>
  </section>
</main>



<script>
  // === Endpoint Formspree ===
  const FORM_ENDPOINT = "https://formspree.io/f/xeorpado"; // đổi nếu bạn tạo endpoint mới

  const formEl = document.getElementById("contactForm");
  const statusEl = document.getElementById("contactStatus");
  const btnEl = document.getElementById("sendBtn");
  const msgEl = document.getElementById("cf-message");
  const countEl = document.getElementById("msgCount");

  // Đếm ký tự message
  const updateCount = () => {
    if (!msgEl || !countEl) return;
    const max = msgEl.getAttribute("maxlength") ? parseInt(msgEl.getAttribute("maxlength"),10) : 0;
    const val = msgEl.value.length;
    countEl.textContent = max ? (val + "/" + max) : val;
  };
  msgEl.addEventListener("input", updateCount);
  updateCount();

  // Helper hiển thị alert
  function showAlert(type, text){
    statusEl.className = "alert show " + (type === "success" ? "success" : "error");
    statusEl.textContent = text;
  }

  // Validate nhỏ phía client
  function setValidity(el, ok, msg){
    const hint = el.parentElement?.querySelector?.(".hint");
    el.classList.toggle("is-invalid", !ok);
    if (hint) hint.textContent = msg || "";
  }

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    showAlert("", "");
    statusEl.classList.remove("show");

    // Simple checks
    const nameEl = document.getElementById("cf-name");
    const emailEl = document.getElementById("cf-email");

    const nameOK = !!nameEl.value.trim();
    const emailOK = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value.trim());
    const msgOK = !!msgEl.value.trim();

    setValidity(nameEl, nameOK, nameOK ? "" : "${_('Vui lòng nhập họ và tên.')}");
    setValidity(emailEl, emailOK, emailOK ? "" : "${_('Vui lòng nhập email hợp lệ.')}");
    setValidity(msgEl, msgOK, msgOK ? "" : "${_('Vui lòng nhập nội dung tin nhắn.')}");

    if (!(nameOK && emailOK && msgOK)) return;

    btnEl.disabled = true;
    btnEl.innerText = "Đang gửi...";

    try {
      const fd = new FormData(formEl);
      fd.append("_subject", "Tin nhắn mới từ trang Liên hệ CUSC LMS");
      if (fd.get("email")) fd.append("_replyto", fd.get("email"));

      const resp = await fetch(FORM_ENDPOINT, {
        method: "POST",
        headers: { "Accept": "application/json" },
        body: fd
      });

      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        throw new Error(data?.error || data?.message || "Send failed");
      }

      formEl.reset();
      updateCount();
      showAlert("success", "✅ ${_('Gửi thành công. Chúng tôi sẽ phản hồi trong thời gian sớm nhất.')}");
    } catch (err) {
      console.error(err);
      showAlert("error", "❌ ${_('Không thể gửi tin nhắn. Vui lòng thử lại sau.')}");
    } finally {
      btnEl.disabled = false;
      btnEl.innerText = "${_('Gửi tin nhắn')}";
    }
  });
</script>
