<%namespace name='static' file='../static_content.html'/>
<%page expression_filter="h"/>
<%! from django.utils.translation import gettext as _ %>
<%inherit file="../main.html" />

<%block name="pagetitle">${_("Contact Us")}</%block>

<main id="main" aria-label="Content" tabindex="-1">
  <section class="container about contact-page">
    <h1 class="contact-title">
      <%block name="pageheader">${page_header or _("Contact")}</%block>
    </h1>

    <p class="contact-intro">
      <%block name="pagecontent">
        ${page_content or _("Got a question or need support? Reach out using the form below or via the contact details on the right.")}
      </%block>
    </p>

    <div class="contact-grid">
      <!-- LEFT: Contact form -->
      <div class="contact-form-card" role="region" aria-labelledby="contact-form-title">
        <div class="card-head">
          <h2 id="contact-form-title" class="section-title">${_("Send us a message")}</h2>
          <span class="badge">CUSC</span>
        </div>

        <!-- Form -->
        <form class="contact-form" id="contactForm" novalidate>
          <div class="grid-2">
            <div class="field">
              <label class="required" for="cf-name">${_("Full name")}</label>
              <input id="cf-name" name="name" type="text" placeholder="${_('Your name')}" required />
              <small class="hint"></small>
            </div>

            <div class="field">
              <label class="required" for="cf-email">${_("Email")}</label>
              <input id="cf-email" name="email" type="email" placeholder="you@example.com" required />
              <small class="hint"></small>
            </div>
          </div>

          <div class="field">
            <label for="cf-subject">${_("Subject")}</label>
            <input id="cf-subject" name="subject" type="text" placeholder="${_('What is this about?')}" />
            <small class="hint"></small>
          </div>

          <div class="field">
            <label class="required" for="cf-message">${_("Message")}</label>
            <textarea id="cf-message" name="message" rows="6" maxlength="1500" placeholder="${_('Write your message here...')}" required></textarea>
            <div class="meta-row">
              <small class="hint"></small>
              <small id="msgCount" class="count">0/1500</small>
            </div>
          </div>

          <button type="submit" class="btn primary" id="sendBtn">
            <span>✉️ ${_("Send message")}</span>
          </button>

          <p class="form-hint">
            ${_("By sending this message, you agree to be contacted at the email you provided.")}
          </p>

          <!-- trạng thái gửi -->
          <div id="contactStatus" class="alert" aria-live="polite"></div>
        </form>
      </div>

      <!-- RIGHT: Contact info -->
      <aside class="contact-info-card" role="complementary" aria-labelledby="contact-info-title">
        <h2 id="contact-info-title" class="section-title">${_("Contact information")}</h2>

        <ul class="contact-list" aria-label="${_('Contact details')}">
          <li><span class="ci-label">${_("Email")}:</span> <a href="mailto:info@cusc.vn">info@cusc.vn</a></li>
          <li><span class="ci-label">${_("Phone")}:</span> <a href="tel:+842922835579">+84 292 2835 579</a></li>
          <li><span class="ci-label">${_("Address")}:</span> ${_("1 Ly Tu Trong St, Ninh Kieu, Can Tho, Vietnam")}</li>
          <li><span class="ci-label">${_("Office hours")}:</span> ${_("Mon–Fri, 08:00–17:00 (GMT+7)")}</li>
        </ul>

        <div class="contact-social">
          <a href="#" aria-label="${_('Facebook')}" class="chip">Facebook</a>
          <a href="#" aria-label="${_('YouTube')}" class="chip">YouTube</a>
          <a href="#" aria-label="${_('Zalo')}" class="chip">Zalo</a>
        </div>
      </aside>
    </div>

    <!-- Map -->
    <div class="contact-map" role="region" aria-label="${_('Location map')}">
      <iframe
        title="${_('CUSC location map')}"
        loading="lazy"
        allowfullscreen
        referrerpolicy="no-referrer-when-downgrade"
        src="https://www.google.com/maps?q=Can+Tho+University+Software+Center&output=embed">
      </iframe>
    </div>
  </section>
</main>



<script>
  // === Endpoint Formspree ===
  const FORM_ENDPOINT = "https://formspree.io/f/xeorpado"; // đổi nếu bạn tạo endpoint mới

  const formEl = document.getElementById("contactForm");
  const statusEl = document.getElementById("contactStatus");
  const btnEl = document.getElementById("sendBtn");
  const msgEl = document.getElementById("cf-message");
  const countEl = document.getElementById("msgCount");

  // Đếm ký tự message
  const updateCount = () => {
    if (!msgEl || !countEl) return;
    const max = msgEl.getAttribute("maxlength") ? parseInt(msgEl.getAttribute("maxlength"),10) : 0;
    const val = msgEl.value.length;
    countEl.textContent = max ? (val + "/" + max) : val;
  };
  msgEl.addEventListener("input", updateCount);
  updateCount();

  // Helper hiển thị alert
  function showAlert(type, text){
    statusEl.className = "alert show " + (type === "success" ? "success" : "error");
    statusEl.textContent = text;
  }

  // Validate nhỏ phía client
  function setValidity(el, ok, msg){
    const hint = el.parentElement?.querySelector?.(".hint");
    el.classList.toggle("is-invalid", !ok);
    if (hint) hint.textContent = msg || "";
  }

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    showAlert("", "");
    statusEl.classList.remove("show");

    // Simple checks
    const nameEl = document.getElementById("cf-name");
    const emailEl = document.getElementById("cf-email");

    const nameOK = !!nameEl.value.trim();
    const emailOK = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value.trim());
    const msgOK = !!msgEl.value.trim();

    setValidity(nameEl, nameOK, nameOK ? "" : "${_('Please enter your name.')}");
    setValidity(emailEl, emailOK, emailOK ? "" : "${_('Please enter a valid email.')}");
    setValidity(msgEl, msgOK, msgOK ? "" : "${_('Message is required.')}");

    if (!(nameOK && emailOK && msgOK)) return;

    btnEl.disabled = true;
    btnEl.innerText = "Sending...";

    try {
      const fd = new FormData(formEl);
      fd.append("_subject", "New message from CUSC LMS Contact Page");
      if (fd.get("email")) fd.append("_replyto", fd.get("email"));

      const resp = await fetch(FORM_ENDPOINT, {
        method: "POST",
        headers: { "Accept": "application/json" },
        body: fd
      });

      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        throw new Error(data?.error || data?.message || "Send failed");
      }

      formEl.reset();
      updateCount();
      showAlert("success", "✅ ${_('Message sent successfully. We’ll get back to you soon.')}");
    } catch (err) {
      console.error(err);
      showAlert("error", "❌ ${_('Could not send your message. Please try again later.')}");
    } finally {
      btnEl.disabled = false;
      btnEl.innerText = "${_('Send message')}";
    }
  });
</script>
