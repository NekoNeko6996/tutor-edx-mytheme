<%page expression_filter="h"/>
<%namespace name='static' file='../static_content.html'/>
<%!
from django.utils.translation import gettext as _
from django.utils.translation import pgettext
from django.urls import reverse, NoReverseMatch
from urllib.parse import urlencode, quote
from lms.djangoapps.courseware.courses import get_course_about_section
from django.conf import settings
from common.djangoapps.edxmako.shortcuts import marketing_link
from openedx.core.djangolib.js_utils import js_escaped_string
from openedx.core.djangolib.markup import clean_dangerous_html, HTML, Text
from openedx.core.lib.courses import course_image_url

def safe_reverse(name, args=None, default="/"):
    try:
        return reverse(name, args=args or [])
    except NoReverseMatch:
        return default

def abs_url(request, path_or_url):
    if path_or_url.startswith(("http://", "https://")):
        return path_or_url
    return request.build_absolute_uri(path_or_url)
%>

<%!
from common.djangoapps.course_modes.models import CourseMode

def get_paid_info(course):
    """
    Trả về (is_paid, amount, currency)
    - is_paid: True nếu có mode 'verified' với min_price > 0
    - amount: số tiền (float/int)
    - currency: mã tiền tệ (VD: VND, USD)
    """
    try:
        mode = (
            CourseMode.objects
            .filter(course_id=course.id, mode_slug='verified')
            .order_by('min_price')
            .first()
        )
        if mode and (mode.min_price or 0) > 0:
            return True, mode.min_price, (mode.currency or '').upper()
    except Exception:
        pass
    return False, None, None

def format_price(amount, currency):
    # format VND: 900.000 ₫
    try:
        amt = float(amount)
    except Exception:
        return ''
    cur = (currency or '').upper()
    if cur in ('VND', 'VNĐ', 'VN'):
        return f"{int(round(amt)):,}".replace(',', '.') + " ₫"
    symbols = {'USD': '$', 'EUR': '€', 'GBP': '£', 'JPY': '¥'}
    if cur in symbols:
        return f"{symbols[cur]}{amt:,.2f}"
    # fallback chung
    if amt.is_integer():
        return f"{int(amt):,} {cur}".replace(',', ',')
    return f"{amt:,.2f} {cur}"
%>


<style>
:root {
  --cusc-blue: #0056A1;
  --accent: #10B981;
  --hero-grad1: var(--cusc-blue);
  --hero-grad2: var(--accent);
  --hero-gradient: linear-gradient(135deg, var(--hero-grad1), var(--hero-grad2));
}

.course-info.about.container {
  position: relative;
  z-index: 1;
  --bg-card: rgba(255,255,255,0.95);
}

.course-profile .info-profile {
  text-align: left !important;
  color: #fff;
  padding-left: 2rem;
}
.course-profile .info-profile h1 {
  color: #fff;
  font-size: 2.4rem;
  font-weight: 800;
  margin-bottom: .4rem;
}
.course-profile .info-profile .org {
  color: rgba(255,255,255,0.85);
  font-size: 1.25rem;
  font-weight: 600;
}

.course-header-wrapper {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  gap: 2rem;
}

.course-sidebar {
  flex: 1;
  min-width: 300px;
  max-width: 420px;
  background: var(--bg-card);
  color: #000;
  border-radius: 14px;
  padding: 1.5rem;
  position: relative;
  box-shadow: 0 4px 14px rgba(0,0,0,0.05);
  overflow: hidden;
}
.course-sidebar::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 14px;
  padding: 2px;
  background: var(--hero-gradient);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: 0;
  transition: opacity .3s ease;
}
.course-sidebar:hover::before {
  opacity: 1;
}

.course-summary h2 {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--cusc-blue);
  border-bottom: 2px solid var(--cusc-blue);
  padding-bottom: .5rem;
  margin-bottom: 1rem;
}

.course-summary .social-links {
  display: flex;
  gap: 12px;
  margin-top: 1.2rem;
}
.course-summary .social-links a {
  display: inline-flex;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--hero-gradient);
  align-items: center;
  justify-content: center;
  color: #fff;
  transition: all .35s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.course-summary .social-links a:hover {
  background: linear-gradient(135deg, var(--accent), var(--cusc-blue));
  transform: scale(1.12);
  box-shadow: 0 4px 14px rgba(16,185,129,0.4);
}

.main-cta {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.main-cta a,
.main-cta .register,
.main-cta .register.disabled,
.main-cta a[href*="course"],
.main-cta a[href*="view"] {
  all: unset;
  display: inline-block;
  background: var(--hero-gradient) !important;
  color: #fff !important;
  font-family: inherit;
  font-weight: 600;
  font-size: 1.1rem;
  padding: .9rem 1.8rem;
  border-radius: 10px;
  text-decoration: none;
  transition: all .3s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
  cursor: pointer;
  border: none;
  text-align: center;
  line-height: 1.3;
}
.main-cta a:hover,
.main-cta .register:hover,
.main-cta .register.disabled:hover,
.main-cta a[href*="course"]:hover,
.main-cta a[href*="view"]:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 18px rgba(0,0,0,0.2);
  filter: brightness(1.05);
}
.main-cta .register.disabled {
  cursor: default;
  opacity: 1;
}
.main-cta a *,
.main-cta .register *,
.main-cta .register.disabled *,
.main-cta a[href*="course"] *,
.main-cta a[href*="view"] * {
  all: unset;
  color: inherit !important;
  font-weight: inherit !important;
  font-size: inherit !important;
  background: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
  display: inline;
}
.main-cta a strong {
  all: unset;
  color: inherit !important;
  font-weight: inherit !important;
  font-size: inherit !important;
  background: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
  display: inline;
}

.about-content {
  margin-top: 2rem;
  background: var(--bg-card);
  border-radius: 12px;
  color: #000;
  position: relative;
  overflow: hidden;

  border: none !important;
}
.about-content::before {
  content: "";
  position: absolute;
  inset: 0;
  padding: 2px;
  border-radius: 12px;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: 0;
  transition: opacity .3s ease;
}
.about-content:hover::before {
  opacity: 1;
}


.registered-mute-btn {
  padding: 1rem;
  border-radius: 5px;
  font-weight: bold;
  color: white;
}

.animation-gradien-background {
	background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
	background-size: 400% 400%;
	animation: gradient 10s ease infinite !important;
}

@keyframes gradient {
	0% {
		background-position: 0% 50%;
	}
	50% {
		background-position: 100% 50%;
	}
	100% {
		background-position: 0% 50%;
	}
}


@media (max-width: 992px) {
  .course-header-wrapper {
    flex-direction: column;
  }
  .course-sidebar {
    max-width: 100%;
  }
  .main-cta {
    justify-content: center;
  }
}
</style>

<%inherit file="../main.html" />
<%block name="headextra">
  <meta property="og:title" content="${course.display_name_with_default}" />
  <meta property="og:description" content="${get_course_about_section(request, course, 'short_description')}" />
</%block>

<%block name="js_extra">
  <script type="text/javascript">
  (function() {
    $(".register").click(function(event) {
      $("#class_enroll_form").submit();
      event.preventDefault();
    });

    $('#class_enroll_form').on('ajax:complete', function(event, xhr) {
      if (xhr.status == 200) {
        if (xhr.responseText == "") {
          location.href = "${reverse('dashboard') | n, js_escaped_string}";
        }
        else {
          location.href = xhr.responseText;
        }
      } else if (xhr.status == 403) {
        // redirect unauthenticated user to the login page
        location.replace("${reverse('signin_user') | n, js_escaped_string}?next=" + encodeURIComponent("${request.path | n, js_escaped_string}"));
      } else {
        $('#register_error').text(
            (xhr.responseText ? xhr.responseText : "${_("Có lỗi xãy ra, vui lòng thử lại sau.") | n, js_escaped_string}")
        ).css("display", "block");
      }
    });
  })(this)
  </script>

  <script src="${static.url('js/course_info.js')}"></script>

 <%
    is_paid_js, _amt_tmp, _cur_tmp = get_paid_info(course)
  %>
  % if user.is_authenticated and request.GET.get('checkout') == '1' and is_paid_js:
    <%
      course_id_str = str(course.id)
      about_path = safe_reverse('about_course', args=[course_id_str], default=f"/courses/{course_id_str}/about")
      about_url  = abs_url(request, about_path)
      # pay_base   = "http://localhost:3000/checkout"
      pay_base = getattr(settings, "CUSC_CHECKOUT_URL", "http://localhost:3000/checkout")
      params     = {'course_id': course_id_str, 'user': user.username, 'next': about_url}
      pay_url_auth = f"{pay_base}?{urlencode(params)}"
    %>
    <script>window.location.replace("${pay_url_auth | n, js_escaped_string}");</script>
  % endif


</%block>

<%block name="pagetitle">${course.display_name_with_default}</%block>

<section class="course-info about container">
  <%block name="course_about_header">
  <header class="course-profile">
    <div class="intro-inner-wrapper">
      <div class="profile-top">
        % if get_course_about_section(request, course, "video"):
        <a href="#video-modal" class="media" rel="leanModal">
          <div class="hero">
            <img src="${course_image_urls['large']}" alt="" aria-hidden="true" />
            <div class="play-intro"></div>
          </div>
        </a>
        % else:
        <div class="media">
          <div class="hero">
            <img src="${course_image_urls['large']}" onerror="this.src='/theming/asset/images/no_course_image.png';" alt="" aria-hidden="true" />
          </div>
        </div>
        % endif
        <div class="info-profile">
          <h1>${course.display_name_with_default}</h1>
          <span class="org">${course.display_org_with_default}</span>
        </div>
      </div>

      <%
        is_paid, paid_amount, paid_currency = get_paid_info(course)
        price_text = format_price(paid_amount, paid_currency) if is_paid else ''
      %>


      <div class="main-cta">
        % if user.is_authenticated and registered:
          <span class="registered-mute-btn animation-gradien-background">${_("Đã đăng ký")}</span>
          % if show_courseware_link:
            <a href="${course_target}"><strong>${_("Xem khóa học")}</strong></a>
          % endif

        % elif is_course_full:
          <span class="register disabled">${_("Khóa học đã hết chổ")}</span>

        % elif invitation_only and not can_enroll:
          <span class="register disabled">${_("Việc đăng ký khóa học này chỉ được thực hiện thông qua lời mời")}</span>

        % elif not is_shib_course and not can_enroll:
          <span class="register closed disabled"><i class="fa fa-lock" aria-hidden="true"></i> ${_("Đã đóng tuyển sinh")}</span>

        % elif allow_anonymous:
          % if show_courseware_link:
            <a href="${course_target}" class="main-btn"><strong>${_("Xem khóa học")}</strong></a>
          % endif

        % else:
          <%
            # URL about tuyệt đối để quay lại sau khi thanh toán
            course_id_str = str(course.id)
            about_path = safe_reverse('about_course', args=[course_id_str], default=f"/courses/{course_id_str}/about")
            about_url  = abs_url(request, about_path)

            # URL checkout Node (đổi khi deploy)
            # pay_base = "http://localhost:3000/checkout"
            pay_base = getattr(settings, "CUSC_CHECKOUT_URL", "http://localhost:3000/checkout")
            params = {
                'course_id': course_id_str,
                'user': user.username if user.is_authenticated else '',
                'next': about_url,
            }
            pay_url_auth = f"{pay_base}?{urlencode(params)}"  # dùng khi đã đăng nhập

            # URL hiển thị trên nút (cta_url): nếu chưa đăng nhập => đi qua trang signin nội bộ
            cta_url = pay_url_auth
            if not user.is_authenticated:
                login_url = None
                for name in ('signin_user', 'login'):
                    try:
                        login_url = reverse(name)
                        break
                    except NoReverseMatch:
                        pass
                if not login_url:
                    login_url = getattr(settings, 'LOGIN_URL', '/login')

                # next = about nội bộ + cờ checkout=1 (tuyệt đối)
                login_next = abs_url(request, f"{about_path}?checkout=1")
                login_url  = abs_url(request, login_url)
                from urllib.parse import quote  # phòng khi chưa import
                cta_url = f"{login_url}?next={quote(login_next, safe='')}"
          %>

          % if is_paid:
            <a class="btn btn-primary" href="${cta_url}">${_("Mua khóa học này")}</a>
          % else:
            <a href="#" class="register">${_("Đăng ký ngay")}</a>
            <div id="register_error"></div>
          % endif
        % endif
      </div>
    </div>
  </header>
  </%block>

  <hr/>

  <div class="about-content">
    <%block name="course_about_details">
    <div class="details">
      % if staff_access and studio_url is not None:
        <div class="wrap-instructor-info studio-view">
          <a class="instructor-info-action" href="${studio_url}">${_("Xem Trang Giới thiệu trong studio")}</a>
        </div>
      % endif

      <div class="inner-wrapper">
        ${clean_dangerous_html(get_course_about_section(request, course, "overview"))}
      </div>
    </div>
    </%block>

    <div class="course-sidebar">
      <div class="course-summary">
        <h2>Tóm tắt khóa học</h2>
        <%block name="course_about_important_dates">
          <%
            is_paid_sb, amt_sb, cur_sb = get_paid_info(course)
            price_text_sb = format_price(amt_sb, cur_sb) if is_paid_sb else ''
          %>
        <ol class="important-dates">
          <li class="important-dates-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M12 3L1 9L5 11.18V17.18L12 21L19 17.18V11.18L21 10.09V17H23V9L12 3ZM18.8201 8.99997L12.0001 12.72L5.18007 8.99997L12.0001 5.27997L18.8201 8.99997ZM12 18.72L17 15.99V12.27L12 15L7 12.27V15.99L12 18.72Z" fill="#9CA3AF"/>
            </svg>
            <p class="important-dates-item-title">${_("Số khóa học")}</p>
            <span class="important-dates-item-text course-number">${course.display_number_with_default}</span>
          </li>

          % if not course.start_date_is_still_default:
            <%
              course_start_date = course.advertised_start or course.start
            %>
            <li class="important-dates-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M18 4H19C20.1 4 21 4.9 21 6V20C21 21.1 20.1 22 19 22H5C3.89 22 3 21.1 3 20L3.01 6C3.01 4.9 3.89 4 5 4H6V2H8V4H16V2H18V4ZM5 10V20H19V10H5ZM19 8H5V6H19V8ZM17 13H12V18H17V13Z" fill="#9CA3AF"/>
              </svg>
              <p class="important-dates-item-title">${_("Lớp học bắt đầu")}</p>
              % if isinstance(course_start_date, str):
                <span class="important-dates-item-text start-date">${course_start_date}</span>
              % else:
                <%
                  course_date_string = course_start_date.strftime('%Y-%m-%dT%H:%M:%S%z')
                %>
                <span class="important-dates-item-text start-date localized_datetime"
                      data-format="shortDate"
                      data-datetime="${course_date_string}"
                      data-language="${LANGUAGE_CODE}"></span>
              % endif
            </li>
          % endif

          % if course.end:
            <%
              course_end_date = course.end
            %>
            <li class="important-dates-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M18 4H19C20.1 4 21 4.9 21 6V20C21 21.1 20.1 22 19 22H5C3.89 22 3 21.1 3 20L3.01 6C3.01 4.9 3.89 4 5 4H6V2H8V4H16V2H18V4ZM5 10V20H19V10H5ZM19 8H5V6H19V8ZM17 13H12V18H17V13Z" fill="#9CA3AF"/>
              </svg>
              <p class="important-dates-item-title">${_("Lớp học kết thúc")}</p>
              % if isinstance(course_end_date, str):
                <span class="important-dates-item-text final-date">${course_end_date}</span>
              % else:
                <%
                  course_date_string = course_end_date.strftime('%Y-%m-%dT%H:%M:%S%z')
                %>
                <span class="important-dates-item-text final-date localized_datetime"
                      data-format="shortDate"
                      data-datetime="${course_date_string}"
                      data-language="${LANGUAGE_CODE}"></span>
              % endif
            </li>
          % endif

          % if get_course_about_section(request, course, "effort"):
            <li class="important-dates-item">
              <span class="icon fa fa-pencil" aria-hidden="true"></span>
              <p class="important-dates-item-title">${_("Nỗ lực ước tính")}</p>
              <span class="important-dates-item-text effort">${get_course_about_section(request, course, "effort")}</span>
            </li>
          % endif

          % if is_paid_sb and price_text_sb:
            <li class="important-dates-item">
              <span class="icon fa fa-money" aria-hidden="true"></span>
              <p class="important-dates-item-title">${_("Giá")}</p>
              <span class="important-dates-item-text">${price_text_sb}</span>
            </li>
          % endif


          % if pre_requisite_courses:
            <%
              prc_key = str(pre_requisite_courses[0]['key'])
              prc_target = safe_reverse('about_course', args=[prc_key], default=f"/courses/{prc_key}/about")
            %>
            <li class="prerequisite-course important-dates-item">
              <span class="icon fa fa-list-ul" aria-hidden="true"></span>
              <p class="important-dates-item-title">${_("Điều kiện tiên quyết")}</p>
              <span class="important-dates-item-text pre-requisite">
                <a href="${prc_target}">${pre_requisite_courses[0]['display']}</a>
              </span>
              <p class="tip">
              ${Text(_("Bạn phải hoàn thành thành công {link_start}{prc_display}{link_end} trước khi bắt đầu hóa học này.")).format(
                link_start=HTML('<a href="{}">').format(prc_target),
                link_end=HTML('</a>'),
                prc_display=pre_requisite_courses[0]['display'],
              )}
              </p>
            </li>
          % endif

          % if get_course_about_section(request, course, "prerequisites"):
            <li class="important-dates-item">
              <span class="icon fa fa-book" aria-hidden="true"></span>
              <p class="important-dates-item-title">${_("Yêu cầu")}</p>
              <span class="important-dates-item-text prerequisites">${get_course_about_section(request, course, "prerequisites")}</span>
            </li>
          % endif
        </ol>
        </%block>
        <%include file="course_about_sidebar_header.html" />
      </div>

      % if get_course_about_section(request, course, "ocw_links"):
      <div class="additional-resources">
        <header>
          <h1>${_("Tài nguyên bổ sung")}</h1>
        </header>
        <div>
          <h2 class="opencourseware">MITOpenCourseware</h2>
          ${get_course_about_section(request, course, "ocw_links")}
        </div>
      </div>
      % endif

      % if sidebar_html_enabled:
        % if get_course_about_section(request, course, "about_sidebar_html"):
          <section class="about-sidebar-html">
            ${get_course_about_section(request, course, "about_sidebar_html")}
          </section>
        % endif
      % endif
    </div>
  </div>
</section>

% if active_reg_button or is_shib_course:
  <%
    change_enroll_url = safe_reverse('change_enrollment', default="/change_enrollment")
  %>
  <div style="display: none;">
    <form id="class_enroll_form" method="post" data-remote="true" action="${change_enroll_url}">
      <fieldset class="enroll_fieldset">
        <legend class="sr">${pgettext("self","Enroll")}</legend>
        <input name="course_id" type="hidden" value="${course.id}">
        <input name="enrollment_action" type="hidden" value="enroll">
      </fieldset>
      <div class="submit">
        <input name="submit" type="submit" value="${pgettext('self','enroll')}">
      </div>
    </form>
  </div>
% endif

<%include file="../video_modal.html" />

<%static:require_module_async module_name="js/dateutil_factory" class_name="DateUtilFactory">
    DateUtilFactory.transform(iterationKey=".localized_datetime");
</%static:require_module_async>
